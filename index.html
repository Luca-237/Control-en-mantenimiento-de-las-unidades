<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Mantenimiento</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      margin: 0; 
      padding: 10px; 
      min-height: 100vh;
    }
    
    .container { 
      max-width: 100%; 
      margin: auto; 
      background: rgba(255, 255, 255, 0.95); 
      padding: 15px; 
      border-radius: 16px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
      backdrop-filter: blur(10px);
    }
    
    h1 { 
      text-align: center; 
      color: #d32f2f; 
      margin-bottom: 20px; 
      font-size: 1.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .logo { 
      display: block; 
      margin: 0 auto 15px auto; 
      max-width: 80px; 
    }
    
    .login-container { 
      text-align: center; 
      margin-top: 40px; 
    }
    
    .login-container input { 
      padding: 12px; 
      border-radius: 8px; 
      border: 2px solid #e0e0e0; 
      width: 90%; 
      max-width: 300px; 
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .login-container input:focus {
      border-color: #28a745;
      outline: none;
    }
    
    .login-container button { 
      margin-top: 15px; 
      padding: 12px 24px; 
      border: none; 
      border-radius: 8px; 
      background: linear-gradient(45deg, #28a745, #20c997); 
      color: white; 
      font-weight: bold; 
      cursor: pointer; 
      font-size: 16px;
      transition: transform 0.2s ease;
    }
    
    .login-container button:hover {
      transform: translateY(-2px);
    }
    
    .unit { 
      border: none;
      border-radius: 12px; 
      padding: 15px; 
      margin: 15px 0; 
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .unit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .unit-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-wrap: wrap; 
      gap: 10px;
    }
    
    .unit-name {
      font-weight: bold;
      font-size: 1.1rem;
      color: #333;
      flex: 1;
      min-width: 200px;
    }
    
    .unit-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .btn { 
      border: none; 
      padding: 8px 12px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600; 
      margin: 2px; 
      font-size: 14px;
      transition: all 0.2s ease;
      min-width: 80px;
      text-align: center;
    }
    
    .btn-success { 
      background: linear-gradient(45deg, #28a745, #20c997); 
      color: white; 
    }
    
    .btn-danger { 
      background: linear-gradient(45deg, #dc3545, #e63946); 
      color: white; 
    }
    
    .btn-warning { 
      background: linear-gradient(45deg, #ffc107, #ffb347); 
      color: #333; 
    }
    
    .btn-secondary { 
      background: linear-gradient(45deg, #6c757d, #5a6268); 
      color: white; 
    }
    
    .btn-info { 
      background: linear-gradient(45deg, #17a2b8, #138496); 
      color: white; 
    }
    
    .btn:hover { 
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .observaciones-container { 
      margin-top: 15px; 
      display: none; 
      animation: slideDown 0.3s ease;
    }
    
    .observaciones-container textarea { 
      width: 100%; 
      padding: 12px; 
      border-radius: 8px; 
      border: 2px solid #e0e0e0; 
      resize: vertical; 
      min-height: 80px; 
      font-family: inherit;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .observaciones-container textarea:focus {
      border-color: #dc3545;
      outline: none;
    }
    
    .herramientas-container { 
      margin-top: 15px; 
      display: none; 
      background: linear-gradient(145deg, #f8f9fa, #e9ecef);
      padding: 20px; 
      border-radius: 12px; 
      border: 2px solid #dee2e6;
      animation: slideDown 0.3s ease;
    }
    
    .herramientas-container h3 {
      margin-top: 0;
      color: #495057;
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .herramienta-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 12px; 
      margin: 8px 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    
    .herramienta-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .herramienta-nombre { 
      font-weight: 600; 
      flex-grow: 1; 
      color: #333;
    }
    
    .herramienta-actions { 
      display: flex; 
      gap: 5px; 
      flex-wrap: wrap;
    }
    
    .btn-small { 
      padding: 6px 10px; 
      font-size: 12px; 
      margin: 0; 
      border-radius: 6px;
    }
    
    .nueva-herramienta { 
      margin-top: 20px; 
      padding: 15px; 
      background: linear-gradient(145deg, #e9ecef, #f8f9fa);
      border-radius: 8px; 
      border: 2px dashed #6c757d;
    }
    
    .nueva-herramienta input { 
      padding: 10px; 
      border-radius: 6px; 
      border: 2px solid #ced4da; 
      width: calc(70% - 5px); 
      margin-right: 10px; 
      font-size: 16px;
    }
    
    .nueva-herramienta button {
      width: calc(30% - 5px);
      min-width: 80px;
    }
    
    .abcm-form { 
      margin-top: 15px; 
      padding: 15px; 
      background: linear-gradient(145deg, #fff3cd, #ffeaa7);
      border: 2px solid #ffc107; 
      border-radius: 8px; 
      display: none; 
    }
    
    .abcm-form h4 { 
      margin: 0 0 15px 0; 
      color: #856404; 
      text-align: center;
    }
    
    .abcm-form select, .abcm-form input, .abcm-form textarea { 
      width: 100%; 
      padding: 10px; 
      border-radius: 6px; 
      border: 2px solid #e0a800; 
      margin-bottom: 10px; 
      font-size: 16px;
    }
    
    .admin-section { 
      margin-top: 30px; 
      padding: 20px; 
      background: linear-gradient(145deg, #e3f2fd, #bbdefb);
      border: 2px solid #2196f3; 
      border-radius: 12px; 
    }
    
    .admin-section h3 { 
      color: #1976d2; 
      margin-top: 0; 
      text-align: center;
    }
    
    .admin-form { 
      display: none; 
      margin-top: 15px; 
      padding: 20px; 
      background: white; 
      border-radius: 8px; 
      border: 2px solid #ddd; 
      animation: slideDown 0.3s ease;
    }
    
    .admin-form input, .admin-form textarea, .admin-form select { 
      width: 100%; 
      padding: 12px; 
      border-radius: 6px; 
      border: 2px solid #ced4da; 
      margin-bottom: 15px; 
      font-size: 16px;
    }
    
    .password-input { 
      background: #fff3cd !important; 
      border: 2px solid #ffc107 !important; 
    }
    
    .hidden-fields { 
      display: none; 
    }
    
    .change-name-container { 
      display: none; 
      margin-top: 10px; 
      padding: 15px; 
      background: linear-gradient(145deg, #e8f5e8, #d4edda);
      border-radius: 8px; 
      border: 2px solid #28a745; 
    }
    
    .change-name-container input { 
      width: 100%; 
      padding: 10px; 
      border-radius: 6px; 
      border: 2px solid #28a745; 
      margin-bottom: 10px; 
      font-size: 16px;
    }
    
    .status { 
      margin-top: 20px; 
      padding: 15px; 
      border-radius: 8px; 
      font-weight: 600; 
      text-align: center; 
      font-size: 14px;
      animation: fadeIn 0.3s ease;
    }
    
    .status-success { 
      background: linear-gradient(145deg, #d4edda, #c3e6cb);
      color: #155724; 
      border: 2px solid #28a745;
    }
    
    .status-error { 
      background: linear-gradient(145deg, #f8d7da, #f1b0b7);
      color: #721c24; 
      border: 2px solid #dc3545;
    }
    
    .admin-herramientas { 
      margin-top: 15px; 
      padding: 15px; 
      background: white; 
      border-radius: 8px; 
      border: 2px solid #ddd; 
      display: none; 
    }
    
    .herramientas-admin-buttons { 
      margin-top: 20px; 
      text-align: center;
    }
    
    .validation-container { 
      margin-top: 15px; 
      padding: 15px; 
      background: linear-gradient(145deg, #fff3cd, #ffeaa7);
      border: 2px solid #ffc107; 
      border-radius: 8px; 
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
        margin: 5px;
        border-radius: 12px;
      }
      
      h1 {
        font-size: 1.3rem;
      }
      
      .unit-header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      
      .unit-name {
        text-align: center;
        min-width: auto;
      }
      
      .unit-buttons {
        justify-content: center;
      }
      
      .btn {
        flex: 1;
        min-width: 0;
        font-size: 12px;
        padding: 10px 8px;
      }
      
      .herramienta-item {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .herramienta-actions {
        justify-content: center;
      }
      
      .nueva-herramienta {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .nueva-herramienta input {
        width: 100%;
        margin: 0;
      }
      
      .nueva-herramienta button {
        width: 100%;
      }
      
      .admin-section {
        padding: 15px;
      }
      
      .admin-section .btn {
        width: 100%;
        margin: 5px 0;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
      
      .container {
        padding: 10px;
      }
      
      .unit {
        padding: 12px;
        margin: 10px 0;
      }
      
      .btn {
        font-size: 11px;
        padding: 8px 6px;
      }
      
      .herramientas-container {
        padding: 15px;
      }
      
      .btn-small {
        font-size: 10px;
        padding: 4px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="login-screen">
    <h1>Ingreso al Sistema</h1>
    <div class="login-container">
      <input type="text" id="nombre-operario" placeholder="Ingrese su nombre">
      <br>
      <button onclick="ingresar()">Ingresar</button>
    </div>
  </div>

  <div class="container" id="app-screen" style="display:none;">
    <h1>Control de Mantenimiento</h1>
    <p><b>Operario:</b> <span id="operario-nombre"></span></p>
    <div id="unidades-container"></div>

    <div class="admin-section">
      <h3>Administraci√≥n de Unidades y Herramientas</h3>
      <p><small>Requiere contrase√±a de administrador</small></p>
      <button class="btn btn-info" onclick="mostrarFormulario('agregar')">+ Agregar Nueva Unidad</button>
      <button class="btn btn-warning" onclick="mostrarFormulario('modificar')">Modificar Unidad</button>
      <button class="btn btn-danger" onclick="mostrarFormulario('eliminar')">Eliminar Unidad</button>

      <div id="form-agregar" class="admin-form">
        <h4>Agregar Nueva Unidad</h4>
        <div id="validacion-agregar">
          <input type="password" id="password-agregar" placeholder="Contrase√±a de administrador" class="password-input">
          <button class="btn btn-info" onclick="validarPassword('agregar')">Validar Contrase√±a</button>
        </div>
        <div id="campos-agregar" class="hidden-fields">
          <input type="text" id="nombre-nueva-unidad" placeholder="Nombre de la nueva unidad">
          <textarea id="herramientas-nueva-unidad" placeholder="Herramientas (una por l√≠nea)" rows="4"></textarea>
          <button class="btn btn-success" onclick="procesarUnidad('agregar')">Crear Unidad</button>
        </div>
        <button class="btn btn-secondary" onclick="ocultarFormularios()">Cancelar</button>
      </div>

      <div id="form-modificar" class="admin-form">
        <h4>Modificar Unidad</h4>
        <div id="validacion-modificar">
            <input type="password" id="password-modificar" placeholder="Contrase√±a de administrador" class="password-input">
            <button class="btn btn-info" onclick="validarPassword('modificar')">Validar Contrase√±a</button>
        </div>
        <div id="campos-modificar" class="hidden-fields">
          <select id="select-unidad-modificar"><option value="">Seleccione una unidad</option></select>
          <input type="text" id="nombre-modificar-unidad" placeholder="Nuevo nombre de la unidad">
          <button class="btn btn-warning" onclick="procesarUnidad('modificar')">Modificar Unidad</button>
        </div>
        <button class="btn btn-secondary" onclick="ocultarFormularios()">Cancelar</button>
      </div>

      <div id="form-eliminar" class="admin-form">
        <h4>‚ö†Ô∏è Eliminar Unidad</h4>
        <p style="color: #dc3545;"><small>Esta acci√≥n no se puede deshacer</small></p>
        <div id="validacion-eliminar">
            <input type="password" id="password-eliminar" placeholder="Contrase√±a de administrador" class="password-input">
            <button class="btn btn-info" onclick="validarPassword('eliminar')">Validar Contrase√±a</button>
        </div>
        <div id="campos-eliminar" class="hidden-fields">
          <select id="select-unidad-eliminar"><option value="">Seleccione una unidad</option></select>
          <button class="btn btn-danger" onclick="procesarUnidad('eliminar')">Eliminar Unidad</button>
        </div>
        <button class="btn btn-secondary" onclick="ocultarFormularios()">Cancelar</button>
      </div>
    </div>

    <div id="status" class="status">Esperando conexi√≥n con el servidor...</div>
  </div>

<script>
    const statusDiv = document.getElementById("status");
    const unidadesContainer = document.getElementById("unidades-container");
    const loginScreen = document.getElementById("login-screen");
    const appScreen = document.getElementById("app-screen");
    const operarioNombreSpan = document.getElementById("operario-nombre");
    let unidades = [];
    let socket;
    let operario = "";
    let passwordValidada = {};
    let adminValidado = false;
    let herramientasAbiertas = null; 

    function ingresar() {
      const nombre = document.getElementById("nombre-operario").value.trim();
      if (!nombre) {
        alert("Por favor ingrese su nombre.");
        return;
      }
      operario = nombre;
      operarioNombreSpan.textContent = operario;
      loginScreen.style.display = "none";
      appScreen.style.display = "block";
      conectarServidor();
    }

    function conectarServidor() {
      const protocol = location.protocol === "https:" ? "wss:" : "ws:";
      const host = window.location.hostname || "localhost";
      const wsUrl = `${protocol}//${host}:3000`;

      socket = new WebSocket(wsUrl);
      socket.onopen = () => {
        statusDiv.textContent = "üü¢ Conectado al servidor";
        statusDiv.className = "status status-success";
      };

      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.tipo === "unidades_actualizadas") {
            unidades = data.unidades;
            renderizarUnidades();
            actualizarSelectoresAdmin();
          } else if (data.tipo === "confirmacion") {
            statusDiv.textContent = data.mensaje;
            statusDiv.className = "status status-success";
          } else if (data.tipo === "error") {
            statusDiv.textContent = data.mensaje;
            statusDiv.className = "status status-error";
          } else if (data.tipo === "password_validado") {
            const accion = data.accion;
            statusDiv.textContent = data.mensaje;
            if (data.valido) {
              passwordValidada[accion] = true;
              if (accion.startsWith('herramientas_')) {
                adminValidado = true;
                const unidadId = accion.substring('herramientas_'.length);
                const validationDiv = document.getElementById(`validacion-herramientas-${unidadId}`);
                const actionsDiv = document.getElementById(`herramientas-actions-container-${unidadId}`);
                if (validationDiv && actionsDiv) {
                  validationDiv.style.display = "none";
                  actionsDiv.style.display = "block";
                }
              } else {
                if (accion === 'agregar' || accion === 'modificar' || accion === 'eliminar') {
                  adminValidado = true;
                }
                mostrarCamposAdmin(accion);
              }
              statusDiv.className = "status status-success";
            } else {
              statusDiv.className = "status status-error";
            }
          }
        } catch (e) {
            console.error("Error parsing message:", e);
            statusDiv.textContent = "Error procesando respuesta del servidor.";
            statusDiv.className = "status status-error";
        }
      };
      socket.onclose = () => {
        statusDiv.textContent = "üî¥ Desconectado. Reintentando conectar...";
        statusDiv.className = "status status-error";
        setTimeout(conectarServidor, 3000);
      };

      socket.onerror = () => {
        statusDiv.textContent = "‚ö†Ô∏è Error de conexi√≥n. Aseg√∫rese que el servidor est√© encendido.";
        statusDiv.className = "status status-error";
      };
    }

    function renderizarUnidades() {
      unidadesContainer.innerHTML = "";
      unidades.forEach((unidad) => {
        const unitDiv = document.createElement("div");
        unitDiv.className = "unit";
        unitDiv.innerHTML = `
          <div class="unit-header">
            <span class="unit-name">${unidad.nombre}</span>
            <div class="unit-buttons">
              <button class="btn btn-success" onclick="registrarMantenimiento('${unidad.id}','${unidad.nombre}',true)">‚úÖ En condiciones</button>
              <button class="btn btn-warning" onclick="mostrarHerramientas('${unidad.id}')">üîß Ver Herramientas</button>
              <button class="btn btn-danger" onclick="mostrarObservaciones('${unidad.id}')">‚ö†Ô∏è No en condiciones</button>
            </div>
          </div>
          <div class="observaciones-container" id="obs-${unidad.id}">
            <textarea id="obs-text-${unidad.id}" placeholder="Escribe observaciones..."></textarea>
            <button class="btn btn-danger" onclick="registrarMantenimiento('${unidad.id}','${unidad.nombre}',false)">Confirmar</button>
          </div>
          <div class="herramientas-container" id="herr-${unidad.id}">
            <h3>üõ†Ô∏è Herramientas de ${unidad.nombre}</h3>
            <div id="lista-herramientas-${unidad.id}">${renderizarHerramientas(unidad)}</div>
            <div class="herramientas-admin-buttons">
              <button class="btn btn-info" onclick="mostrarFormularioHerramientas('${unidad.id}')">üîß Administrar</button>
            </div>
            <div id="admin-herramientas-${unidad.id}" style="display: none;">
              <div id="validacion-herramientas-${unidad.id}" class="validation-container">
                <input type="password" id="password-herramientas-${unidad.id}" placeholder="Contrase√±a de administrador" class="password-input">
                <button class="btn btn-info" onclick="validarPassword('herramientas_${unidad.id}')">Validar Contrase√±a</button>
              </div>
              <div id="herramientas-actions-container-${unidad.id}" style="display: none;">
                <div class="nueva-herramienta">
                  <input type="text" id="nueva-herr-${unidad.id}" placeholder="Nombre de la nueva herramienta">
                  <button class="btn btn-success btn-small" onclick="agregarHerramienta('${unidad.id}')">+ Agregar</button>
                </div>
                <div class="abcm-form" id="abcm-${unidad.id}">
                  <h4>Registro ABCM</h4>
                  <select id="tipo-abcm-${unidad.id}">
                    <option value="alta">Alta</option>
                    <option value="baja">Baja</option>
                    <option value="cambio">Cambio</option>
                    <option value="modificacion">Modificaci√≥n</option>
                  </select>
                  <input type="text" id="herramienta-abcm-${unidad.id}" placeholder="Nombre de la herramienta" readonly>
                  <div class="change-name-container" id="cambio-nombre-${unidad.id}">
                    <input type="text" id="nueva-herramienta-${unidad.id}" placeholder="Nuevo nombre de la herramienta">
                  </div>
                  <textarea id="detalle-abcm-${unidad.id}" placeholder="Detalles del movimiento ABCM..."></textarea>
                  <button class="btn btn-warning" onclick="registrarABCM('${unidad.id}')">Registrar</button>
                  <button class="btn btn-secondary" onclick="cancelarABCM('${unidad.id}')">Cancelar</button>
                </div>
              </div>
            </div>
            <button class="btn btn-secondary" onclick="ocultarHerramientas('${unidad.id}')">Cerrar</button>
          </div>
        `;
        unidadesContainer.appendChild(unitDiv);
      });
    }

    function renderizarHerramientas(unidad) {
      if (!unidad.herramientas || unidad.herramientas.length === 0) {
        return '<p>No hay herramientas registradas para esta unidad.</p>';
      }
      return unidad.herramientas.map(herramienta => `
        <div class="herramienta-item">
          <span class="herramienta-nombre">${herramienta}</span>
          <div class="herramienta-actions">
            <button class="btn btn-warning btn-small" onclick="iniciarABCM('${unidad.id}', '${herramienta}', 'modificacion')">Modificar</button>
            <button class="btn btn-warning btn-small" onclick="iniciarABCM('${unidad.id}', '${herramienta}', 'cambio')">Cambiar</button>
            <button class="btn btn-danger btn-small" onclick="iniciarABCM('${unidad.id}', '${herramienta}', 'baja')">Dar de baja</button>
          </div>
        </div>
      `).join('');
    }

    function mostrarObservaciones(unidadId) { 
      if (herramientasAbiertas) {
        ocultarHerramientas(herramientasAbiertas);
      }
      document.getElementById(`obs-${unidadId}`).style.display = "block"; 
    }
    
    function mostrarHerramientas(unidadId) {
      if (herramientasAbiertas && herramientasAbiertas !== unidadId) {
        ocultarHerramientas(herramientasAbiertas);
      }
      
      if (herramientasAbiertas === unidadId) {
        ocultarHerramientas(unidadId);
        return;
      }
      
      herramientasAbiertas = unidadId;
      document.getElementById(`herr-${unidadId}`).style.display = "block";
      document.getElementById(`admin-herramientas-${unidadId}`).style.display = "none";
    }

    function mostrarFormularioHerramientas(unidadId) {
      document.getElementById(`admin-herramientas-${unidadId}`).style.display = "block";
      if (adminValidado) {
        const validationDiv = document.getElementById(`validacion-herramientas-${unidadId}`);
        const actionsDiv = document.getElementById(`herramientas-actions-container-${unidadId}`);
        if (validationDiv) validationDiv.style.display = "none";
        if (actionsDiv) actionsDiv.style.display = "block";
        passwordValidada[`herramientas_${unidadId}`] = true;
      } else {
        const validationDiv = document.getElementById(`validacion-herramientas-${unidadId}`);
        const actionsDiv = document.getElementById(`herramientas-actions-container-${unidadId}`);
        if (validationDiv) validationDiv.style.display = "block";
        if (actionsDiv) actionsDiv.style.display = "none";
      }
    }
    
    function ocultarHerramientas(unidadId) {
      document.getElementById(`herr-${unidadId}`).style.display = "none";
      if (herramientasAbiertas === unidadId) {
        herramientasAbiertas = null;
      }
    }

    function agregarHerramienta(unidadId) {
      if (!adminValidado && !passwordValidada[`herramientas_${unidadId}`]) {
          alert("Error: La contrase√±a no ha sido validada.");
          return;
      }
      const input = document.getElementById(`nueva-herr-${unidadId}`);
      const nombreHerramienta = input.value.trim();
      if (!nombreHerramienta) return alert("Ingrese el nombre de la herramienta");
      const passwordInput = document.getElementById(`password-herramientas-${unidadId}`);
      let password = "";
      if (passwordInput && passwordInput.value) {
        password = passwordInput.value;
      } else if (adminValidado) {
        password = "bomberos2024";
      }
      socket.send(JSON.stringify({ tipo: "agregar_herramienta", unidadId, herramienta: nombreHerramienta, operario, password }));
      input.value = "";
    }

    function iniciarABCM(unidadId, herramienta, tipo) {
      if (!adminValidado && !passwordValidada[`herramientas_${unidadId}`]) {
          const validationDiv = document.getElementById(`validacion-herramientas-${unidadId}`);
          const actionsDiv = document.getElementById(`herramientas-actions-container-${unidadId}`);
          if (validationDiv && actionsDiv) {
            validationDiv.style.display = "block";
            actionsDiv.style.display = "none";
          }
          statusDiv.textContent = "Debes validar la contrase√±a para modificar herramientas";
          statusDiv.className = "status status-error";
          return;
      }
      const form = document.getElementById(`abcm-${unidadId}`);
      const cambioNombreContainer = document.getElementById(`cambio-nombre-${unidadId}`);
      document.getElementById(`tipo-abcm-${unidadId}`).value = tipo;
      document.getElementById(`herramienta-abcm-${unidadId}`).value = herramienta;
      if (tipo === 'cambio' || tipo === 'modificacion') {
        cambioNombreContainer.style.display = "block";
        document.getElementById(`nueva-herramienta-${unidadId}`).value = herramienta;
      } else {
        cambioNombreContainer.style.display = "none";
      }
      form.style.display = "block";
    }

    function cancelarABCM(unidadId) {
      const form = document.getElementById(`abcm-${unidadId}`);
      form.style.display = "none";
      document.getElementById(`cambio-nombre-${unidadId}`).style.display = "none";
      document.getElementById(`detalle-abcm-${unidadId}`).value = "";
      document.getElementById(`nueva-herramienta-${unidadId}`).value = "";
    }

    function registrarABCM(unidadId) {
      if (!adminValidado && !passwordValidada[`herramientas_${unidadId}`]) {
          alert("Error: La contrase√±a no ha sido validada.");
          return;
      }
      const tipo = document.getElementById(`tipo-abcm-${unidadId}`).value;
      const herramienta = document.getElementById(`herramienta-abcm-${unidadId}`).value;
      const detalle = document.getElementById(`detalle-abcm-${unidadId}`).value.trim();
      if (!detalle) return alert("Debe ingresar los detalles del movimiento ABCM");
      const passwordInput = document.getElementById(`password-herramientas-${unidadId}`);
      let password = "";
      if (passwordInput && passwordInput.value) {
        password = passwordInput.value;
      } else if (adminValidado) {
        password = "bomberos2024";
      }
      const mensaje = { tipo: "abcm", unidadId, tipoABCM: tipo, herramienta, detalle, operario, password };
      if (tipo === 'cambio' || tipo === 'modificacion') {
        const nuevaHerramienta = document.getElementById(`nueva-herramienta-${unidadId}`).value.trim();
        if (!nuevaHerramienta) return alert("Debe ingresar el nuevo nombre de la herramienta");
        mensaje.herramientaOriginal = herramienta;
        mensaje.herramientaNueva = nuevaHerramienta;
      }
      socket.send(JSON.stringify(mensaje));
      cancelarABCM(unidadId);
    }

    function registrarMantenimiento(unidadId, nombreUnidad, enCondiciones) {
      let observaciones = "Sin observaciones (Unidad en condiciones)";
      if (!enCondiciones) {
        observaciones = document.getElementById(`obs-text-${unidadId}`).value.trim();
        if (!observaciones) {
          statusDiv.textContent = "Ingresa observaciones antes de confirmar";
          statusDiv.className = "status status-error";
          return;
        }
      }
      socket.send(JSON.stringify({ tipo: "mantenimiento", unidad: nombreUnidad, observaciones, operario }));
      if (!enCondiciones) {
        document.getElementById(`obs-text-${unidadId}`).value = "";
        document.getElementById(`obs-${unidadId}`).style.display = "none";
      }
    }

    function mostrarFormulario(accion) {
      ocultarFormularios();
      document.getElementById(`form-${accion}`).style.display = "block";
    }

    function ocultarFormularios() {
      ['agregar', 'modificar', 'eliminar'].forEach(accion => {
        const form = document.getElementById(`form-${accion}`);
        if(form) form.style.display = "none";
        const campos = document.getElementById(`campos-${accion}`);
        if(campos) campos.classList.add('hidden-fields');
        const validacion = document.getElementById(`validacion-${accion}`);
        if(validacion) validacion.style.display = 'block';
        const passwordInput = document.getElementById(`password-${accion}`);
        if(passwordInput) passwordInput.value = "";
        passwordValidada[accion] = false;
      });
    }

    function mostrarCamposAdmin(accion) {
      document.getElementById(`campos-${accion}`).classList.remove('hidden-fields');
      document.getElementById(`validacion-${accion}`).style.display = 'none';
    }

    function actualizarSelectoresAdmin() {
      const selects = ['select-unidad-modificar', 'select-unidad-eliminar'];
      selects.forEach(selectId => {
        const selectElem = document.getElementById(selectId);
        if (selectElem) {
          selectElem.innerHTML = '<option value="">Seleccione una unidad</option>';
          unidades.forEach(unidad => {
            selectElem.innerHTML += `<option value="${unidad.id}">${unidad.nombre}</option>`;
          });
        }
      });
    }

    function validarPassword(accion) {
      const passwordInput = document.getElementById(`password-${accion}`);
      const password = passwordInput ? passwordInput.value : "";
      if (!password) {
        statusDiv.textContent = "‚ö†Ô∏è Ingrese la contrase√±a";
        statusDiv.className = "status status-error";
        return;
      }
      socket.send(JSON.stringify({ tipo: "validar_password", password, accion }));
    }

    function procesarUnidad(accion) {
      if (!adminValidado && !passwordValidada[accion]) {
        alert("Error: La contrase√±a no ha sido validada. Por favor, valide primero.");
        return;
      }
      let password = "";
      if (passwordValidada[accion]) {
        const passwordInput = document.getElementById(`password-${accion}`);
        password = passwordInput ? passwordInput.value : "bomberos2024";
      } else if (adminValidado) {
        password = "bomberos2024";
      }
      let mensaje = { tipo: `${accion}_unidad`, password };
      if (accion === 'agregar') {
        mensaje.nombre = document.getElementById('nombre-nueva-unidad').value.trim();
        if (!mensaje.nombre) return alert("Ingrese el nombre de la unidad");
        const herramientasText = document.getElementById('herramientas-nueva-unidad').value.trim();
        mensaje.herramientas = herramientasText ? herramientasText.split('\n').map(h => h.trim()).filter(h => h) : [];
      } else if (accion === 'modificar') {
        mensaje.unidadId = document.getElementById('select-unidad-modificar').value;
        mensaje.nombre = document.getElementById('nombre-modificar-unidad').value.trim();
        if (!mensaje.unidadId || !mensaje.nombre) return alert("Seleccione una unidad e ingrese un nuevo nombre.");
      } else if (accion === 'eliminar') {
        mensaje.unidadId = document.getElementById('select-unidad-eliminar').value;
        if (!mensaje.unidadId) return alert("Seleccione una unidad para eliminar.");
        const unidad = unidades.find(u => u.id === mensaje.unidadId);
        if (!confirm(`¬øEst√° seguro de eliminar la unidad "${unidad.nombre}"?`)) return;
      }
      socket.send(JSON.stringify(mensaje));
      setTimeout(ocultarFormularios, 500);
    }
</script>

</body>
</html>

